function isU(o){return"undefined"==typeof o}function isD(o){return"undefined"!=typeof o}function _log(){for(var m=arguments.length,i=0;m>i;i+=1)"object"==typeof arguments[i]?console.dir(arguments[i]):console.log(arguments[i])}var App=angular.module("app",["app.auth","app.sumstat","ui.bootstrap","ui.router","LocalStorageModule","ngAnimate","angularMoment"]).run(["amMoment","$rootScope","$state","$stateParams",function(amMoment,$rootScope,$state,$stateParams){_log("App run ..."),amMoment.changeLocale("ru"),$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.user=null}]),AppAuth=angular.module("app.auth",["ui.router"]).run(["Auth","$rootScope",function(AuthService,$rootScope){_log("AppAuth run ..."),$rootScope.isAuthenticated=AuthService.isAuthenticated()}]).controller("AuthCtrl",["$scope","$rootScope","Auth",function($scope,$rootScope,AuthService){$scope.loginModel="alexey",$scope.passwordModel="",$scope.loginError=!1,$scope.passwordError=!1,$scope.Auth=function(event){_log("$scope.Auth Call ...",$scope.loginModel,$scope.passwordModel);var noErrors=!0;""==$.trim($scope.loginModel)&&(noErrors=!1,$scope.loginError=!0),""==$.trim($scope.passwordModel)&&(noErrors=!1,$scope.passwordError=!0),noErrors&&($scope.loginError=!1,$scope.passwordError=!1,AuthService.login({login:$.trim($scope.loginModel),password:$.trim($scope.passwordModel)}))},$scope.keyAuth=function(event){13==event.keyCode?$scope.Auth():27==event.keyCode}}]).factory("Auth",["$http","$q","Api",function($http,$q,Api){var authenticatedUser=!0;return{isAuthenticated:function(){return authenticatedUser},login:function(inputs){var deffered=$q.defer();return Api.login({login:inputs.login,password:inputs.password}).success(function(data){_log("Auth login success Data:",data),deffered.resolve(data)}).error(function(data,status,header,config){_log("Auth login error Data:",arguments),deffered.reject(data)}),deffered.promise}}}]);App.factory("Api",["$q",function($q){var _apiUrl="https://test.sendsay.ru/admin/api/";return{_prepeareRequest:function(request){return{request:JSON.stringify(request),apiversion:100,json:1}},hasError:function(responce){return isD(responce.errors)&&responce.errors.length},request:function(request,options){options=options||{};var self=this,_deffered=$q.defer(),_fullRequest=this._prepeareRequest(request),ajaxSettings={url:_apiUrl,crossDomain:!0,async:!0,cache:!1,dataType:"json",global:!0,method:options.method||"post",data:_fullRequest,error:function(data){_log("API ERROR: ",arguments)},success:function(data){self.hasError(data)?_deffered.reject(data):_deffered.resolve(data)}};return $.ajax(ajaxSettings),_deffered.promise},login:function(options){return $http({method:"POST",url:_apiUrl+"api/",data:{credential_0:options.login,credential_1:options.password}})}}}]),App.factory("SumstatFavorites",["$rootScope","localStorageService",function($rootScope,localStorageService){_log("localStorageService:",localStorageService);var keyName="sumstatFavoriteUsers";localStorageService.get(keyName)||localStorageService.set(keyName,"");var list=localStorageService.get(keyName).split(",")||[],saveList=function(){localStorageService.set(keyName,list.join(","))},service={getList:function(){return list.slice(0)},Add:function(id){id=id||null,"object"!=typeof id&&id&&!this.inList(id)&&(list.push(id),saveList(),$rootScope.$broadcast("SumstatFavorites_Add",id),$rootScope.$broadcast("SumstatFavorites_Change",list))},Remove:function(id){id=id||null;var index=$.inArray(id,list);"object"!=typeof id&&id&&-1!=index&&(list.splice(index,1),saveList(),$rootScope.$broadcast("SumstatFavorites_Remove",id),$rootScope.$broadcast("SumstatFavorites_Change",list))},inList:function(id){return-1!=$.inArray(id,list)}};return service}]);var AppFilters=angular.module("AppFilters",[]);AppFilters.filter("sumstatPaginationFilter",function(){return _log("sumstatpagination arguments:",arguments),function(items,currentPage,itemsPerPage){return items.slice((currentPage-1)*itemsPerPage,currentPage*itemsPerPage-1)}}),App.directive("tarifInfo",function(){var _TARIFS={B:{name:"Базовый",limit:{email:null,sms:null},showChange:0},R:{name:"Расширеный",limit:{email:null,sms:null},price:0,showChange:0},N:{name:"Начальный",limit:{email:null,sms:null},price:0,showChange:0},O:{name:"Оптимальный",limit:{email:null,sms:null},price:0,showChange:0},P:{name:"Профессиональный",limit:{email:null,sms:null},price:0,showChange:0},E:{name:"Эксперт",limit:{email:null,sms:null},price:0,showChange:0},V:{name:"Премиум",limit:{email:null,sms:null},price:0,showChange:0},S:{name:"Свои",limit:{email:null,sms:null},price:0,showChange:0},F:{name:"Старт",limit:{email:200,sms:null},price:0,showChange:0},U:{name:"Т1",limit:{email:2e3,sms:null},price:0,showChange:0},Q:{name:"Т2",limit:{email:1e4,sms:null},price:0,showChange:0},X:{name:"Т3",limit:{email:2e4,sms:null},price:0,showChange:0},Y:{name:"Т4",limit:{email:35e3,sms:null},price:0,showChange:0},Z:{name:"Т5",limit:{email:5e4,sms:null},price:0,showChange:0},T:{name:"Тестовый",limit:{email:null,sms:null},price:0,showChange:0},trial:{name:"Триал",limit:{email:null,sms:null},price:0,showChange:0},B1:{name:"Бизнес 1",id:"Sendsay_B1_fee",limit:{email:1e3,sms:null},price:750,showChange:1},B2:{name:"Бизнес 2",id:"Sendsay_B2_fee",limit:{email:2500,sms:null},price:1300,showChange:1},B5:{name:"Бизнес 5",id:"Sendsay_B5_fee",limit:{email:5e3,sms:null},price:2e3,showChange:1},B10:{name:"Бизнес 10",id:"Sendsay_B10_fee",limit:{email:1e4,sms:null},price:3300,showChange:1},B25:{name:"Бизнес 25",id:"Sendsay_B25_fee",limit:{email:25e3,sms:null},price:6500,showChange:1},B50:{name:"Бизнес 50",id:"Sendsay_B50_fee",limit:{email:5e4,sms:null},price:10300,showChange:1},I:{name:"Индивидуальный",limit:{email:0,sms:null},price:null,showChange:1},T1:{name:"Т1",limit:{email:2e3,sms:null},price:0,showChange:0},T2:{name:"Т2",limit:{email:1e4,sms:null},price:0,showChange:0},T3:{name:"Т3",limit:{email:2e4,sms:null},price:0,showChange:0},T4:{name:"Т4",limit:{email:35e3,sms:null},price:0,showChange:0},T5:{name:"Т5",limit:{email:5e4,sms:null},price:0,showChange:0}};return{scope:{},restrict:"E",replace:!0,link:function($scope,iElm,iAttrs,controller){var code=iAttrs.code||!1,option=iAttrs.option||"name";_log(code,option),iElm.text(_.get(_TARIFS,[code,option],"Unknown"))}}}),App.config(["$stateProvider","$urlRouterProvider","$locationProvider","localStorageServiceProvider",function($stateProvider,$urlRouterProvider,$locationProvider,localStorageServiceProvider){_log("App config ..."),$locationProvider.html5Mode(!0),localStorageServiceProvider.setPrefix("SA"),localStorageServiceProvider.setStorageType("localStorage"),$urlRouterProvider.when("/","/sumstat").otherwise("/404")}]),App.controller("MainCtrl",["$rootScope","$state","$stateParams","Auth","localStorageService",function($rootScope,$state,$stateParams,Auth,localStorageService){$rootScope.windowTitle="MyFirst Page in Angular",$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.localStorage=localStorageService,$rootScope.isAuthenticated=Auth.isAuthenticated()}]),App.controller("favoritesCtrl",["$scope","$rootScope","SumstatFavorites",function($scope,$rootScope,SumstatFavorites){$rootScope.sumstatFavoriteUsers=SumstatFavorites.getList(),$rootScope.isFavoriteUser=function(id){return SumstatFavorites.inList(id)},$scope.removeFromFavorites=function(id){_log("removeFromFavorites: "+id),SumstatFavorites.Remove(id)},$scope.$watch("sumstatFavoriteUsers",function(){_log("event",arguments)}),$scope.$on("SumstatFavorites_Change",function(event,list){$rootScope.sumstatFavoriteUsers=list}),$scope.showDrop=function(){},_log("favoritesCtrl ...")}]),App.controller("NavogationCtrl",["$scope","$location",function($scope,$location){_log("NavogationCtrl ..."),$scope.mainMenu=[{name:"Sumstat",icon:"glyphicon glyphicon-signal",path:"/sumstat/",state:"sumstat.list"},{name:"Delivstat",path:"/delivstat/",state:"delivstat.list",icon:"glyphicon glyphicon-pencil"},{name:"Payment",path:"/payment/",state:"payment.list",icon:"glyphicon glyphicon-euro"},{name:"Tarif",path:"/tarif/",state:"tarif.list",icon:"glyphicon glyphicon-briefcase"},{name:"Sending",path:"/sending/",state:"sending.list",icon:"glyphicon glyphicon-envelope"}],$scope.$watchCollection("mainMenu",function(){_log("Performe RUN: "+$("#left-panel").length),$("#left-panel").css({left:-80,opacity:.25}).animate({left:0,opacity:1},500)})}]),App.controller("TopSearchCtrl",["$scope","$state","$rootScope","$location",function($scope,$state,$rootScope,$location){$scope.searchlist=[{name:"chrights",code:"chrights"},{name:"Defer",code:"defer"},{name:"Chenv",code:"chenv"}],$scope.doSearch=function(str){0==$scope.searchSection},$scope.$watch("searchInput",function(data){_log("searchInput",data)}),$scope.searchSection=0,$scope.setSection=function(event,index){$scope.searchSection=index,event.preventDefault(),_log("setSection arguments:",arguments)}}]);var AppSumstat=angular.module("app.sumstat",["ui.router","LocalStorageModule","AppFilters"]).config(["$stateProvider","$httpProvider","$urlRouterProvider","$locationProvider",function($stateProvider,$httpProvider,$urlRouterProvider,$locationProvider){_log("app.sumstat config ..."),$urlRouterProvider.when("/sumstat/","/sumstat"),$stateProvider.state("sumstat",{"abstract":!0,url:"/sumstat",template:'<div class="ui-main-conteiner" ui-view></div>',resolve:["$q","Api","$rootScope","$state","$stateParams",function($q,Api,$rootScope,$state,$stateParams){var deferred=$q.defer();$rootScope.userList=[],$rootScope.userList_keyLink={},$rootScope.activeUsers=[],$rootScope.blockedUsers=[];var _listHandler=function(data){var len=Object.keys(data.list).length,uList=[];if($rootScope.userCount=len,_log("$rootScope.userCount: "+Object.keys(data.list).length),data.list&&len){for(var key in data.list){var user=data.list[key];$rootScope.userList_keyLink[key]=uList.push(user)-1,"0"==user.BLOCKED?$rootScope.blockedUsers.push(user.ID):$rootScope.activeUsers.push(user.ID)}$rootScope.userList=uList}$rootScope.$emit("changeUserList"),deferred.resolve()};return Api.request({action:"account.sumstat"}).then(_listHandler),deferred.promise}]}).state("sumstat.list",{url:"",templateUrl:"pages/sumstat/list/template.html",controller:"SumstatListCtrl"}).state("sumstat.view",{"abstract":!0,url:"/view/:userId",templateUrl:"pages/sumstat/user_view/template.html",controller:["$scope","$stateParams",function($scope,$stateParams){var index=$scope.userList_keyLink[$stateParams.userId];$scope.user=$scope.userList[index]}]}).state("sumstat.view.detail",{url:"",templateUrl:"pages/sumstat/user_view/card/template.html",controller:"SumstatUserViewCtrl"})}]);AppSumstat.controller("SumstatListCtrl",["$scope","$rootScope","$location","Api","SumstatFavorites",function($scope,$rootScope,$location,api,SumstatFavorites){$scope.userCount=$rootScope.userList.length,$scope.currentPage=$location.search().page||1,$scope.sortType=$location.search().sortType||"ID",$scope.sortReverse=$location.search().sortReverse||!1,$scope.showAdvCols={},$scope.tableCols=[{key:"manager",name:"Менеджер",checked:0},{key:"seller",name:"Продавец",checked:0},{key:"tarif",name:"Тариф",checked:0},{key:"adress",name:"Адрес",checked:0},{key:"lastIssue",name:"Последний выпуск",checked:0},{key:"memberCount",name:"Адресов в базе",checked:0}],angular.forEach($scope.tableCols,function(value,key){$scope.showAdvCols[value.key]=0}),$scope.changeSort=function(type){$scope.sortReverse=$scope.sortType!=type?0:!$scope.sortReverse,$scope.sortType=type},$scope.favoriteUser=function(event,id){SumstatFavorites.inList(id)?SumstatFavorites.Remove(id):SumstatFavorites.Add(id)},$scope.pageChanged=function(currentPage){$scope.currentPage=currentPage,$location.search("page",currentPage)},$scope.checkOnDrop=function(event,key){var item=$(event.currentTarget).parents(".ui-table-dropdown-item"),isChecked=event.currentTarget.checked;item[(isChecked?"add":"remove")+"Class"]("ui-table-dropdown-checked")},$scope.$watch("sortType",function(){$location.search("sortType",$scope.sortType)}),$scope.$watch("sortReverse",function(){$location.search("sortReverse",$scope.sortReverse?1:null)}),$rootScope.$on("changeUserList",function(){$scope.userCount=Object.keys($rootScope.userList).length})}]),AppSumstat.controller("SumstatUserViewCtrl",["$scope","$rootScope","$stateParams","$location",function($scope,$rootScope,$stateParams,$location){_log("$stateParams.userId: "+$stateParams.userId);var userIndex=$rootScope.userList_keyLink[$stateParams.userId];$scope.user=$rootScope.userList[userIndex],_log("$scope.user: ",_.extend({},$scope.user)),$scope.userJSON=JSON.stringify($scope.user).replace(/\,/gi,",\n").replace(/\{/gi,"{\n").replace(/\}/gi,"\n}")}]);